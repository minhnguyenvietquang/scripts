@version=5
indicator(TTM FCF Yield %, precision = 3, format = format.percent)

var frequency = FY
int timeframeInSeconds = timeframe.in_seconds()
int totalSecondsIn12Months = 365  24  60  60
var frequencyUnit = if frequency == FY 
    math.round(totalSecondsIn12Months  timeframeInSeconds)
else 
    math.round(totalSecondsIn12Months  timeframeInSeconds  4)
fcf = request.financial(syminfo.tickerid, CASH_F_OPERATING_ACTIVITIES, TTM, barmerge.gaps_on)
enterpriseValue = request.financial(syminfo.tickerid, 'ENTERPRISE_VALUE', frequency, barmerge.gaps_on)
totalSharesOutstanding = request.financial(syminfo.tickerid, TOTAL_SHARES_OUTSTANDING, frequency, barmerge.gaps_on)
marketCap =  totalSharesOutstanding  close

dilutionRatio = request.financial(syminfo.tickerid, 'TOTAL_SHARES_OUTSTANDING', frequency, barmerge.gaps_on)  request.financial(syminfo.tickerid, 'DILUTED_SHARES_OUTSTANDING', frequency, barmerge.gaps_on)

 Free Cashflow yield
fcfYield = fcf  enterpriseValue  100
fcfYieldDiluted = if dilutionRatio = 1 
    fcfYield  dilutionRatio
else 
    fcfYield


plot(fcfYield, FCF Yield Net, color =  color.new(color.lime, 20), style =  plot.style_columns, linewidth = 2  )
plot(fcfYieldDiluted, FCF Yield Diluted, color =  color.new(color.green, 60), style =  plot.style_area, linewidth = 3  )

if fcfYieldDiluted  0
    label.new(bar_index, fcfYieldDiluted, str.tostring(fcfYieldDiluted, format.percent), style = label.style_none, textcolor = color.white)

var lastYear = float(na)
var lastBar = int(na)
var last10Years = array.newfloat(10, na)
if not na(fcfYieldDiluted)
    log.info({0}, fcfYieldDiluted)
    lastBar = bar_index
    lastYear = fcfYieldDiluted
    last10Years.push(fcfYieldDiluted)
    if (last10Years.size()  10)
        last10Years.shift()


if barstate.islast
    
    log.info(log {0}, {1},, lastBar, last10Years)
    var last2YearsAvg = array.avg(last10Years.slice(last10Years.size() - 2, last10Years.size()))
    var last5YearsAvg = array.avg(last10Years.slice(last10Years.size() - 5, last10Years.size()))
    var last10YearsAvg = array.avg(last10Years)

    
    if not na(lastYear)
        var labelText = Avg FCF Yield % Diluted +n1Y  + str.tostring(lastYear, format.percent) + n2Y  + str.tostring(last2YearsAvg, format.percent) + n5Y  + str.tostring(last5YearsAvg, format.percent) + n10Y  + str.tostring(last10YearsAvg, format.percent)
        var xLoc = lastBar + math.round(1.2  frequencyUnit)
        var yLoc = math.abs(lastYear  0.9)
        label.new(xLoc, yLoc, labelText, style = label.style_label_left, color = color.green, textcolor = color.white)
